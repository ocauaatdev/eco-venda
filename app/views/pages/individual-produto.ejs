<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- CSS -->
    <link rel="stylesheet" href="/css/individual-produto.css">

    <%- include('../partial/essenciais'); %> 
    <title><%= produto.tituloProd %></title>
</head>
<body>
    <%- include('../partial/header'); %>
    <main>
        <section class="container">
            <section class="imgContainer">
                <img src="<%= produto.imagemProd %>" alt="<%= produto.tituloProd %>">
            </section>
            <section class="produtoInfo">
                <h3 class="nomeProduto"><%= produto.tituloProd %></h3>
                <h2>R$<%= produto.valorProd %></h2>
                <h1>6 x de R$<%= (produto.valorProd / 6).toFixed(2) %> + juros no cartão</h1>

                <h3>Selecione o tamanho:</h3>
                
                <% 
                const tamanhos = produto.tamanhoProd ? produto.tamanhoProd.split(',') : [];
                const tamanhosDisponiveis = ['Pequeno', 'Médio', 'Grande', 'P', 'M', 'G', 'GG'];

                if (tamanhos.length > 0) { %>
                    <select name="tamanhoProduto" id="tamanhoSelecionado">
                        <option value="" disabled selected>Selecione um tamanho</option>
                        <% 
                        let hasSpecificSize = false;
                        tamanhos.forEach(tamanho => { 
                            const tamanhoFormatado = tamanho.trim();
                            if (tamanhosDisponiveis.includes(tamanhoFormatado)) {
                                hasSpecificSize = true;
                                %>
                                <option value="<%= tamanhoFormatado %>"><%= tamanhoFormatado %></option>
                            <% }
                        }); 
                        
                        // Se não houver tamanhos específicos, exibe a opção "Sem tamanho específico"
                        if (!hasSpecificSize) { %>
                            <option value="Sem tamanho específico">Sem tamanho específico</option>
                        <% } 
                        %>
                    </select>
                <% } else { %>
                    <select name="tamanhoProduto" id="tamanhoSelecionado">
                        <option value="Sem tamanho específico">Sem tamanho específico</option>
                    </select>
                <% } %>

                <section class="buttons">
                <button>Comprar</button> 
                <button class="adicionarCarrinho" 
                        data-id="<%= produto.idProd %>" 
                        data-nome="<%= produto.tituloProd %>" 
                        data-preco="<%= produto.valorProd %>" 
                        data-imagem="<%= produto.imagemProd %>">
                    Adicionar ao carrinho
                </button>
                </section>
                
            </section>
        </section>

        <section class="infos">
            <section class="infoContainer">
                <h3>Vendedor: <%= produto.razaoSocial %></h3>
                <h2>Descrição do produto:</h2>
                <p><%= produto.descricaoProd %></p>
            </section>
        </section>
    </main>
    <%- include('../partial/footer'); %>
    <%- include('../partial/scripts-essenciais'); %>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const adicionarCarrinhoButtons = document.querySelectorAll('.adicionarCarrinho');

            adicionarCarrinhoButtons.forEach(button => {
                button.addEventListener('click', function(event) {
                    const id = button.getAttribute('data-id');
                    const nome = button.getAttribute('data-nome');
                    const preco = button.getAttribute('data-preco');
                    const imagem = button.getAttribute('data-imagem');
                    const tamanho = document.getElementById('tamanhoSelecionado').value;

                    // Verifica se o usuário selecionou um tamanho
                    if (!tamanho || tamanho === "Selecione um tamanho") {
                        showNotification("Por favor, selecione um tamanho antes de adicionar ao carrinho!", 'error');
                        return;
                    }

                    fetch('/add-to-cart', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ id, nome, preco, imagem, tamanho })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification("Produto adicionado ao carrinho!");
                            updateCartItemCount();
                        }
                    })
                    .catch(err => console.error("Erro ao adicionar ao carrinho:", err));
                });
            });

            function updateCartItemCount() {
                fetch('/cart-item-count')
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('cart-item-count').textContent = data.count;
                        document.getElementById('contador').textContent = `${data.count} Itens`;
                    })
                    .catch(err => console.error("Erro ao atualizar o contador do carrinho:", err));
            }

            function showNotification(message, status = 'success') {
                new Notify({
                    status: status,
                    title: status === 'success' ? 'Produto Adicionado!' : 'Erro!',
                    text: message,
                    effect: 'slide',
                    speed: 500,
                    autoplay: true,
                    showIcon: true,
                    showCloseButton: true,
                    showDuration: 3000,
                    theme: 'dark',
                    position: 'right top'
                });
            }
        });
    </script>
</body>
</html>
